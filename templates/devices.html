{% extends "base.html" %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold">Device Management</h1>
        <p class="text-muted-foreground">Manage and monitor your network devices</p>
    </div>
    <div class="flex items-center gap-4">
        <button class="btn btn-secondary" onclick="discoverDevices()">
            <i class="fas fa-search"></i>
            Discover Devices
        </button>
        <button class="btn btn-primary" onclick="showAddDeviceModal()">
            <i class="fas fa-plus"></i>
            Add Device
        </button>
    </div>
</div>

 Device Statistics 
<div class="grid grid-cols-4 mb-6">
    <div class="card">
        <div class="card-header">
            <div class="card-title">Total Devices</div>
            <i class="fas fa-server" style="color: var(--chart-1);"></i>
        </div>
        <div class="metric-value">{{ devices|length }}</div>
        <div class="metric-label">Monitored devices</div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">Healthy</div>
            <i class="fas fa-check-circle" style="color: var(--chart-2);"></i>
        </div>
        <div class="metric-value">{{ devices|selectattr('status', 'equalto', 'healthy')|list|length }}</div>
        <div class="metric-label">Online devices</div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">Warning</div>
            <i class="fas fa-exclamation-triangle" style="color: var(--chart-3);"></i>
        </div>
        <div class="metric-value">{{ devices|selectattr('status', 'equalto', 'warning')|list|length }}</div>
        <div class="metric-label">Need attention</div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="card-title">Critical</div>
            <i class="fas fa-times-circle" style="color: var(--chart-4);"></i>
        </div>
        <div class="metric-value">{{ devices|selectattr('status', 'equalto', 'critical')|list|length }}</div>
        <div class="metric-label">Offline devices</div>
    </div>
</div>

 Device List 
<div class="card">
    <div class="card-header">
        <div class="card-title">All Devices</div>
        <div class="flex items-center gap-4">
            <input type="text" id="deviceSearch" placeholder="Search devices..." class="input" style="width: 200px;">
            <select id="deviceFilter" class="btn btn-secondary">
                <option value="">All Types</option>
                <option value="server">Servers</option>
                <option value="network">Network</option>
                <option value="printer">Printers</option>
                <option value="storage">Storage</option>
            </select>
        </div>
    </div>
    
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Device Name</th>
                    <th>IP Address</th>
                    <th>Type</th>
                    <th>Response Time</th>
                    <th>Tags</th>
                    <th>Last Seen</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="deviceTableBody">
                {% for device in devices %}
                <tr data-device-id="{{ device.id }}" data-device-type="{{ device.device_type }}">
                    <td>
                        <div class="status-indicator status-{{ device.status }}">
                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                            <span class="capitalize">{{ device.status }}</span>
                        </div>
                    </td>
                    <td>
                        <div>
                            <div class="font-medium">{{ device.name }}</div>
                            <div class="text-sm text-muted-foreground">{{ device.description or 'No description' }}</div>
                        </div>
                    </td>
                    <td>
                        <code class="text-sm">{{ device.ip }}</code>
                        {% if device.port != 22 %}
                        <div class="text-xs text-muted-foreground">Port: {{ device.port }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-{{ device.device_type }}">
                            <i class="fas fa-{{ 'server' if device.device_type == 'server' else 'network-wired' if device.device_type == 'network' else 'print' if device.device_type == 'printer' else 'hdd' }}"></i>
                            {{ device.device_type.title() }}
                        </span>
                    </td>
                    <td>
                        {% if device.response_time > 0 %}
                            <span class="{% if device.response_time > 100 %}text-warning{% elif device.response_time > 200 %}text-destructive{% endif %}">
                                {{ device.response_time }}ms
                            </span>
                        {% else %}
                            <span class="text-destructive">Offline</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="flex flex-wrap gap-1">
                            {% for tag in device.tags %}
                            <span class="tag">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <div class="text-sm">
                            {% if device.last_seen %}
                                {{ device.last_seen }}
                            {% else %}
                                <span class="text-muted-foreground">Never</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="editDevice({{ device.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="testConnection({{ device.id }})">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="btn btn-destructive btn-sm" onclick="deleteDevice({{ device.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

 Add/Edit Device Modal 
<div id="deviceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Device</h3>
            <button class="btn btn-secondary" onclick="closeDeviceModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="deviceForm">
            <div class="form-group">
                <label for="deviceName">Device Name *</label>
                <input type="text" id="deviceName" name="name" class="input" required>
            </div>
            
            <div class="form-group">
                <label for="deviceIP">IP Address *</label>
                <input type="text" id="deviceIP" name="ip_address" class="input" required 
                       pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" 
                       placeholder="192.168.1.100">
            </div>
            
            <div class="grid grid-cols-2">
                <div class="form-group">
                    <label for="deviceType">Device Type *</label>
                    <select id="deviceType" name="device_type" class="input" required>
                        <option value="">Select type...</option>
                        <option value="server">Server</option>
                        <option value="network">Network Device</option>
                        <option value="printer">Printer</option>
                        <option value="storage">Storage</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="devicePort">Port</label>
                    <input type="number" id="devicePort" name="port" class="input" value="22" min="1" max="65535">
                </div>
            </div>
            
            <div class="form-group">
                <label for="deviceDescription">Description</label>
                <textarea id="deviceDescription" name="description" class="input" rows="3" 
                          placeholder="Brief description of the device..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="deviceTags">Tags</label>
                <input type="text" id="deviceTags" name="tags" class="input" 
                       placeholder="production, web, database (comma-separated)">
                <div class="text-xs text-muted-foreground mt-1">
                    Separate multiple tags with commas
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeviceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Device
                </button>
            </div>
        </form>
    </div>
</div>

 Discovery Modal 
<div id="discoveryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Network Discovery</h3>
            <button class="btn btn-secondary" onclick="closeDiscoveryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="form-group">
            <label for="networkRange">Network Range</label>
            <input type="text" id="networkRange" class="input" value="192.168.1.0/24" 
                   placeholder="192.168.1.0/24">
            <div class="text-xs text-muted-foreground mt-1">
                CIDR notation (e.g., 192.168.1.0/24)
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDiscoveryModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="startDiscovery()">
                <i class="fas fa-search"></i>
                Start Discovery
            </button>
        </div>
        
        <div id="discoveryResults" class="mt-4" style="display: none;">
            <h4>Discovered Devices</h4>
            <div id="discoveredDevicesList"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentEditingDevice = null;

// Device management functions
function showAddDeviceModal() {
    document.getElementById('modalTitle').textContent = 'Add New Device';
    document.getElementById('deviceForm').reset();
    currentEditingDevice = null;
    document.getElementById('deviceModal').style.display = 'flex';
}

function editDevice(deviceId) {
    // Find device data from the table
    const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
    if (!row) return;
    
    currentEditingDevice = deviceId;
    document.getElementById('modalTitle').textContent = 'Edit Device';
    
    // Populate form with existing data (you'd fetch this from API in real implementation)
    document.getElementById('deviceModal').style.display = 'flex';
}

function closeDeviceModal() {
    document.getElementById('deviceModal').style.display = 'none';
    currentEditingDevice = null;
}

function deleteDevice(deviceId) {
    if (!confirm('Are you sure you want to remove this device from monitoring?')) return;
    
    fetch(`/api/devices/${deviceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error deleting device: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting device');
    });
}

function testConnection(deviceId) {
    // Mock connection test
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
        alert('Connection test completed (mock)');
    }, 2000);
}

// Device form submission
document.getElementById('deviceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const deviceData = {
        name: formData.get('name'),
        ip_address: formData.get('ip_address'),
        device_type: formData.get('device_type'),
        port: parseInt(formData.get('port')) || 22,
        description: formData.get('description'),
        tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag)
    };
    
    const url = currentEditingDevice ? `/api/devices/${currentEditingDevice}` : '/api/devices/add';
    const method = currentEditingDevice ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeDeviceModal();
            location.reload();
        } else {
            alert('Error saving device: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving device');
    });
});

// Network discovery functions
function discoverDevices() {
    document.getElementById('discoveryModal').style.display = 'flex';
}

function closeDiscoveryModal() {
    document.getElementById('discoveryModal').style.display = 'none';
    document.getElementById('discoveryResults').style.display = 'none';
}

function startDiscovery() {
    const networkRange = document.getElementById('networkRange').value;
    const resultsDiv = document.getElementById('discoveryResults');
    const listDiv = document.getElementById('discoveredDevicesList');
    
    resultsDiv.style.display = 'block';
    listDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Scanning network...</div>';
    
    fetch('/api/devices/discover', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ network_range: networkRange })
    })
    .then(response => response.json())
    .then(data => {
        if (data.devices && data.devices.length > 0) {
            listDiv.innerHTML = data.devices.map(device => `
                <div class="flex items-center justify-between p-3 border rounded mb-2">
                    <div>
                        <div class="font-medium">${device.hostname}</div>
                        <div class="text-sm text-muted-foreground">${device.ip} - ${device.device_type}</div>
                        <div class="text-xs">Ports: ${device.ports.join(', ')}</div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addDiscoveredDevice('${device.ip}', '${device.hostname}', '${device.device_type}')">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            `).join('');
        } else {
            listDiv.innerHTML = '<div class="text-center text-muted-foreground">No new devices discovered</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        listDiv.innerHTML = '<div class="text-center text-destructive">Error during discovery</div>';
    });
}

function addDiscoveredDevice(ip, hostname, deviceType) {
    closeDiscoveryModal();
    
    // Pre-fill the add device form
    document.getElementById('deviceName').value = hostname;
    document.getElementById('deviceIP').value = ip;
    document.getElementById('deviceType').value = deviceType;
    
    showAddDeviceModal();
}

// Search and filter functionality
document.getElementById('deviceSearch').addEventListener('input', function() {
    filterDevices();
});

document.getElementById('deviceFilter').addEventListener('change', function() {
    filterDevices();
});

function filterDevices() {
    const searchTerm = document.getElementById('deviceSearch').value.toLowerCase();
    const filterType = document.getElementById('deviceFilter').value;
    const rows = document.querySelectorAll('#deviceTableBody tr');
    
    rows.forEach(row => {
        const deviceName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const deviceIP = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const deviceType = row.dataset.deviceType;
        
        const matchesSearch = deviceName.includes(searchTerm) || deviceIP.includes(searchTerm);
        const matchesFilter = !filterType || deviceType === filterType;
        
        row.style.display = matchesSearch && matchesFilter ? '' : 'none';
    });
}
</script>
{% endblock %}
